<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RandomWiki</title>
    
    <!-- Visualization Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }
        .start-container {
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 40px 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
        }
        h1 { 
            font-size: clamp(2em, 8vw, 3em); 
            margin-bottom: 15px; 
        }
        .start-container p {
            font-size: clamp(1em, 3vw, 1.2em);
            margin-bottom: 25px;
            color: #666;
        }
        .start-button {
            padding: 15px 40px;
            font-size: clamp(1em, 3vw, 1.3em);
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
            max-width: 300px;
        }
        .start-button:active {
            transform: scale(0.98);
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #667eea33; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        
        /* Mobile-specific styles */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .start-container {
                padding: 30px 20px;
                border-radius: 15px;
            }
            h1 {
                margin-bottom: 10px;
            }
            .start-button {
                padding: 12px 30px;
            }
        }
        
        /* Small mobile devices */
        @media (max-width: 480px) {
            .start-container {
                padding: 25px 15px;
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div class="start-container">
            <h1> RandomWiki</h1>
            <p>AI-Powered Dynamic Encyclopedia</p>
            <button class="start-button" onclick="startExploring()"> Start Exploring</button>
            <div id="loading" style="margin-top:30px;display:none;"><span class="spinner"></span> Generating... (This might take 2-3 mins)</div>
            <p style="margin-top:30px;font-size:0.9em;color:#888;">Created by akshat</p>
        </div>
    </div>
    <script>
        async function startExploring() {
            document.getElementById('loading').style.display = 'block';
            const res = await fetch('/generate-initial-ui', {method: 'POST'});
            const data = await res.json();
            if (data.success) {
                document.getElementById('app-container').innerHTML = data.html;
                if (data.css) {
                    const style = document.createElement('style');
                    style.textContent = data.css;
                    document.head.appendChild(style);
                }
            }
        }
        async function generateTopicPage(topic) {
            console.log('🚀 Starting 3-part generation for topic:', topic);
            
            // Show loading message immediately
            document.getElementById('app-container').innerHTML = `
                <div style="text-align:center;padding:60px 20px;background:rgba(255,255,255,0.95);border-radius:20px;max-width:600px;margin:0 auto;">
                    <div style="font-size:3em;margin-bottom:20px;">⏳</div>
                    <h2 style="color:#333;margin-bottom:15px;">Generating Content...</h2>
                    <p style="color:#666;font-size:1.1em;">This might take 2-3 minutes</p>
                    <div style="margin-top:30px;">
                        <span class="spinner"></span>
                    </div>
                </div>
            `;
            
            try {
                // Clean up any previous animations
                console.log('🧹 Cleaning up previous animations...');
                
                // Remove all old p5 instances
                if (window.p5Instances) {
                    window.p5Instances.forEach(instance => {
                        if (instance && instance.remove) instance.remove();
                    });
                    window.p5Instances = [];
                }
                
                // Clear any animation loops
                if (window.animationFrameId) {
                    cancelAnimationFrame(window.animationFrameId);
                    window.animationFrameId = null;
                }
                
                // Stop GSAP animations
                if (typeof gsap !== 'undefined') {
                    gsap.killTweensOf('*');
                }
                
                // PART 1: Generate HTML structure
                console.log('📄 PART 1: Generating HTML structure...');
                const htmlRes = await fetch('/generate-html', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({topic})
                });
                const htmlData = await htmlRes.json();
                
                if (!htmlData.success) {
                    throw new Error(htmlData.error || 'Failed to generate HTML');
                }
                
                // Inject HTML
                document.getElementById('app-container').innerHTML = htmlData.html;
                console.log('✅ PART 1 Complete: HTML injected');
                
                // Wait a bit for DOM to settle
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // PART 2: Generate and inject CSS
                console.log('🎨 PART 2: Generating CSS styles...');
                const cssRes = await fetch('/generate-css', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({topic})
                });
                const cssData = await cssRes.json();
                
                if (cssData.success && cssData.css) {
                    const style = document.createElement('style');
                    style.textContent = cssData.css;
                    document.head.appendChild(style);
                    console.log('✅ PART 2 Complete: CSS applied');
                }
                
                // Wait a bit more
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // PART 3: Generate and execute animation JavaScript
                console.log('🎬 PART 3: Generating animation...');
                const jsRes = await fetch('/generate-animation', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({topic})
                });
                const jsData = await jsRes.json();
                
                if (jsData.success && jsData.javascript) {
                    console.log('📝 Animation code received:', jsData.javascript.length, 'characters');
                    console.log('First 200 chars:', jsData.javascript.substring(0, 200));
                    
                    // Verify visual-demo div exists
                    const visualDemo = document.getElementById('visual-demo');
                    if (!visualDemo) {
                        console.error('❌ visual-demo div not found!');
                    } else {
                        console.log('✅ visual-demo div found, executing animation...');
                        
                        // Clear the visual-demo div
                        visualDemo.innerHTML = '';
                        
                        // Execute animation in isolated scope
                        try {
                            const script = document.createElement('script');
                            script.textContent = `
                                (function() {
                                    ${jsData.javascript}
                                })();
                            `;
                            document.body.appendChild(script);
                            console.log('✅ PART 3 Complete: Animation executed');
                        } catch (err) {
                            console.error('❌ Animation execution error:', err);
                            visualDemo.innerHTML = '<div style="padding:40px;text-align:center;color:red;">Animation Error: ' + err.message + '</div>';
                        }
                    }
                } else {
                    console.warn('⚠️ No animation code received');
                }
                
                // Start streaming article content
                console.log('📖 Starting article content stream...');
                streamArticleContent(topic);
                
            } catch (e) {
                console.error('❌ Error in generation process:', e);
                document.getElementById('app-container').innerHTML = `
                    <div style="text-align:center;padding:60px;">
                        <h2>Error</h2>
                        <p>${e.message}</p>
                        <button onclick="location.reload()" style="padding:15px 30px;margin-top:20px;background:#667eea;color:white;border:none;border-radius:8px;cursor:pointer;">🏠 Go Home</button>
                    </div>`;
            }
        }
        async function streamArticleContent(topic) {
            const contentEl = document.getElementById('article-content');
            if (!contentEl) return;
            let text = '';
            const res = await fetch('/generate-content', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({topic})});
            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            while (true) {
                const {done, value} = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value);
                chunk.split('\n').forEach(line => {
                    if (line.startsWith('data: ')) {
                        try {
                            const d = JSON.parse(line.slice(6));
                            if (d.text) { text += d.text; contentEl.innerHTML = formatMarkdown(text); }
                            if (d.done) { document.getElementById('article-loading').style.display = 'none'; contentEl.style.display = 'block'; const rt = document.getElementById('related-topics'); if (rt) rt.style.display = 'block'; }
                        } catch (e) {}
                    }
                });
            }
        }
        function formatMarkdown(text) {
            text = text.replace(/^## (.+)$/gm, '<h2>$1</h2>').replace(/^### (.+)$/gm, '<h3>$1</h3>').replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            return text.split('\n\n').map(p => p.trim() && !p.includes('<h2>') && !p.includes('<h3>') ? `<p>${p.trim()}</p>` : p).join('\n');
        }
    </script>
</body>
</html>
